<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Design Quest ‚Äì Spot & Win (Pro v3.1 Clean)</title>
<style>
  :root{
    --bg:#f7f4ef; --ink:#1c1c1c; --muted:#8e8e8e; --accent:#009e9e; --card:#ffffff;
    --ok:#15b36d; --err:#d13f3f; --shadow:0 10px 30px rgba(0,0,0,.08); --radius:18px;
  }
  [data-theme="night"]{ --bg:#0e1114; --ink:#e7f0f0; --muted:#8ea5a5; --accent:#2ad1d1; --card:#141a1d; --shadow:0 12px 28px rgba(0,0,0,.35) }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font-family: Inter, ui-sans-serif, system-ui;
    color:var(--ink);
    background: radial-gradient(900px 600px at 80% -10%, rgba(0,158,158,.12), transparent 70%) no-repeat, var(--bg);
    transition: background-color .25s ease, color .25s ease;
  }
  .container{max-width:1240px;margin:32px auto 48px;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center;font-weight:800}
  .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 6px rgba(0,158,158,.12)}
  .hud{display:flex;gap:10px;flex-wrap:wrap}
  .pill{background:#eef7f7;border:1px solid rgba(0,158,158,.25);color:#0a5353;padding:8px 12px;border-radius:999px;font-weight:800;font-size:13px}
  [data-theme="night"] .pill{background:#142124;color:#9adfdf;border-color:#1c3e3e}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .hero{padding:26px 24px;border-bottom:1px solid #e8e8e8;display:flex;gap:16px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  [data-theme="night"] .hero{border-color:#26343a}
  .title{font-size:26px;margin:0 0 6px 0}
  .subtitle{margin:0;color:var(--muted)}
  button,.btn{appearance:none;border:none;background:var(--accent);color:white;padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:800;transition:transform .05s ease, opacity .2s ease;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  button:active{transform:translateY(1px)}
  .btn-secondary{background:#e9f7f7;color:#0c5555}
  .btn-ghost{background:transparent;color:var(--accent);border:1px solid rgba(0,158,158,.35)}
  .btn-warning{background:#ffe7b3;color:#6a5207}
  .stage{position:relative;min-height:560px;display:flex;align-items:stretch;justify-content:stretch;padding:18px}
  .panel{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:10px;flex:1;min-height:520px}
  .boards{display:grid;grid-template-columns:1fr 1fr;gap:12px;flex:1}
  .board{background:linear-gradient(180deg,#fafafa,#f2f2f2);border-radius:12px;position:relative;overflow:hidden;border:1px solid #ececec}
  [data-theme="night"] .board{background:linear-gradient(180deg,#0f1418,#0c1013);border-color:#1a2328}
  svg{width:100%;height:100%}
  .divider{height:1px;background:#eee;margin:8px 0}
  [data-theme="night"] .divider{background:#25343a}
  .status{display:flex;align-items:center;gap:8px}
  .shake{animation:shake .25s ease}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}
  .toast{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(10px);transition:all .25s ease;z-index:9999;font-weight:800}
  .toast.show{opacity:1;transform:translateY(0)}
  .badge{background:#e6fbf9;color:#035e5e;border:1px solid #bfeeed;padding:6px 8px;border-radius:10px;font-size:12px;font-weight:800}
  .legend{display:flex;gap:10px;flex-wrap:wrap}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  #fx,#zoomFx{position:fixed;inset:0;pointer-events:none}
  #zoomFx{mix-blend-mode:multiply;opacity:0;transition:opacity .2s ease}
  /* Modal paywall */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:99999}
  .modal .box{background:var(--card);padding:20px;border-radius:16px;box-shadow:var(--shadow);max-width:560px;width:92%}
  .modal h2{margin:0 0 6px 0}
  .modal p{margin:6px 0;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid #d8eaea;outline:none;background:#fff;min-width:180px}
</style>
</head>
<body>
<canvas id="fx"></canvas>
<canvas id="zoomFx"></canvas>

<!-- Paywall Modal -->
<div class="modal" id="paywall">
  <div class="box">
    <h2>Unlock <span style="color:var(--accent)">Pro Levels</span></h2>
    <p>You're on fire! Get endless levels, daily challenges, and pro power‚Äëups without limits.</p>
    <ul style="margin:6px 0 0 18px;color:var(--muted)">
      <li>Unlimited Endless mode</li>
      <li>Daily global challenge</li>
      <li>Freeze & Zoom power‚Äëups x10</li>
      <li>Exclusive ‚ÄúArchitect Story‚Äù episodes</li>
    </ul>
    <div class="row">
      <button id="buyBtn">üöÄ Continue ‚Äì Pro Pass</button>
      <button class="btn btn-secondary" id="shareBtn">üîó Share to unlock</button>
    </div>
    <div class="row">
      <input id="redeemCode" type="text" placeholder="Have a code? (e.g., DESIGN‚ÄëVIP)">
      <button class="btn btn-ghost" id="redeemBtn">Redeem</button>
    </div>
    <p style="font-size:12px">Tip: Sharing this game with 3 friends unlocks Pro for free on this device.</p>
  </div>
</div>

<div class="container">
  <header>
    <div class="brand"><span class="dot"></span>Design Quest ‚Äì Spot & Win <span class="badge" id="modeBadge">Classic</span></div>
    <div class="hud">
      <div class="pill" id="levelPill">Level: 1</div>
      <div class="pill" id="foundPill">Found: 0 / 5</div>
      <div class="pill" id="timerPill">Time: 00:00</div>
      <div class="pill" id="scorePill">Score: 0</div>
      <div class="pill" id="bestPill">Best: ‚Äî</div>
    </div>
  </header>

  <div class="card">
    <div class="hero">
      <div>
        <h1 class="title">Pro v3.1 ‚Äî Clean & Commercial.</h1>
        <p class="subtitle">Differences blend into the design; found spots pulse then vanish. Daily & Endless challenges + viral share.</p>
        <div class="legend"><span class="badge" id="achBadge">No Achievements Yet</span></div>
      </div>
      <div class="toolbar">
        <button id="startBtn">Start / Restart</button>
        <button class="btn btn-secondary" id="nextBtn">Next Level</button>
        <button class="btn btn-ghost" id="endlessBtn">‚àû Endless</button>
        <button class="btn btn-ghost" id="dailyBtn">üìÖ Daily</button>
        <button class="btn btn-warning" id="freezeBtn" title="Freeze timer 5s">üßä Freeze</button>
        <button class="btn btn-ghost" id="zoomBtn" title="Zoom lens 4s">üîç Zoom</button>
        <button class="btn btn-ghost" id="shareChallengeBtn" title="Copy a challenge link">üèÜ Share challenge</button>
        <button class="btn btn-ghost" id="themeBtn">üåô Night</button>
        <button class="btn btn-ghost" id="muteBtn" aria-pressed="false">üîä Sound On</button>
      </div>
    </div>

    <div class="stage">
      <div class="panel" id="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;color:var(--muted)">Game Boards</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="badge" id="diffCountBadge">5 differences</span>
            <span class="badge" id="penaltyBadge">+2s misclick</span>
          </div>
        </div>
        <div class="boards">
          <div class="board"><svg id="svgLeft" viewBox="0 0 600 420" preserveAspectRatio="xMidYMid slice"></svg></div>
          <div class="board"><svg id="svgRight" viewBox="0 0 600 420" preserveAspectRatio="xMidYMid slice"></svg></div>
        </div>
        <div class="divider"></div>
        <div class="status" id="statusLine">Click the differences on the right board.</div>
      </div>
    </div>
    <footer>Host as <strong>index.html</strong> on GitHub Pages. Embed URL in Canva via <strong>Apps ‚Üí Embed</strong>.</footer>
  </div>
</div>

<div class="toast" id="toast">Correct!</div>

<script>
/* ====== Utilities & Audio ====== */
const $ = sel => document.querySelector(sel);
const fmt = s => String(s).padStart(2,'0');
const store=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch(e){return d}};
let muted=false; const ac=new (window.AudioContext||window.webkitAudioContext)();
function sfx(type="ok"){ if(muted) return;
  const o=ac.createOscillator(), g=ac.createGain(); o.connect(g); g.connect(ac.destination); const t=ac.currentTime;
  if(type==="ok"){o.type="sine";o.frequency.setValueAtTime(920,t);g.gain.setValueAtTime(.0001,t);g.gain.exponentialRampToValueAtTime(.22,t+.01);g.gain.exponentialRampToValueAtTime(.0001,t+.25)}
  if(type==="win"){o.type="triangle";o.frequency.setValueAtTime(420,t);o.frequency.linearRampToValueAtTime(760,t+.25);o.frequency.linearRampToValueAtTime(1110,t+.55);g.gain.setValueAtTime(.0001,t);g.gain.exponentialRampToValueAtTime(.28,t+.01);g.gain.exponentialRampToValueAtTime(.0001,t+.6)}
  if(type==="miss"){o.type="sawtooth";o.frequency.setValueAtTime(160,t);g.gain.setValueAtTime(.0001,t);g.gain.exponentialRampToValueAtTime(.18,t+.01);g.gain.exponentialRampToValueAtTime(.0001,t+.18)}
  o.start(); o.stop(t+.7);
}
function toast(text){const el=$("#toast"); el.textContent=text; el.classList.add("show"); clearTimeout(toast._t); toast._t=setTimeout(()=>el.classList.remove("show"), 950);}

/* ====== Confetti ====== */
const fx = $("#fx").getContext("2d");
const fxCanvas = $("#fx"); function fxResize(){fxCanvas.width=innerWidth; fxCanvas.height=innerHeight} window.addEventListener('resize',fxResize); fxResize();
const parts=[]; function confetti(n=120){ for(let i=0;i<n;i++){ parts.push({x:Math.random()*fxCanvas.width,y:-10,vx:-2+Math.random()*4,vy:2+Math.random()*3,rot:Math.random()*6,vr:-.1+.2*Math.random(),s:4+Math.random()*6,life:120+Math.random()*60}) } }
;(function loop(){ fx.clearRect(0,0,fxCanvas.width,fxCanvas.height); parts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.rot+=p.vr;p.life--; fx.save(); fx.translate(p.x,p.y); fx.rotate(p.rot); fx.fillStyle=`hsl(${(p.x+p.y)%360},70%,${50+(p.vr*50)}%)`; fx.fillRect(-p.s/2,-p.s/2,p.s,p.s); fx.restore();}); for(let i=parts.length-1;i>=0;i--) if(parts[i].life<=0||parts[i].y>fxCanvas.height+20) parts.splice(i,1); requestAnimationFrame(loop) })();

/* ====== Zoom Lens (visual overlay hint) ====== */
const zoomC = $("#zoomFx"); const zctx = zoomC.getContext("2d"); function zResize(){zoomC.width=innerWidth; zoomC.height=innerHeight} window.addEventListener('resize',zResize); zResize();
let zoomActive=false, zoomTimeout=null;
function startZoom(ms=4000){
  zoomActive=true; $("#zoomFx").style.opacity=1; const rect=$("#svgRight").getBoundingClientRect();
  function draw(e){ if(!zoomActive) return; zctx.clearRect(0,0,zoomC.width,zoomC.height);
    const x=Math.min(Math.max(e.clientX,rect.left),rect.right); const y=Math.min(Math.max(e.clientY,rect.top),rect.bottom); const r=80;
    zctx.save(); zctx.beginPath(); zctx.arc(x,y,r,0,Math.PI*2); zctx.clip(); zctx.fillStyle="rgba(0,0,0,0.25)"; zctx.fillRect(0,0,zoomC.width,zoomC.height); zctx.restore();
  }
  window.addEventListener("mousemove",draw); draw({clientX:rect.left+rect.width/2, clientY:rect.top+rect.height/2});
  clearTimeout(zoomTimeout); zoomTimeout=setTimeout(()=>{ zoomActive=false; $("#zoomFx").style.opacity=0; window.removeEventListener("mousemove",draw); },ms);
}

/* ====== Scene Generator (neutral styling for differences) ====== */
function drawScene(svg, seed, mods=[], options={}){
  svg.innerHTML="";
  const NS="http://www.w3.org/2000/svg";
  let s=seed; function rnd(){ s=(s*9301+49297)%233280; return s/233280; } function pick(a){return a[Math.floor(rnd()*a.length)]}

  // bg + grid
  const gradId = "g"+Math.floor(Math.random()*1e6);
  const defs=document.createElementNS(NS,"defs");
  const grad=document.createElementNS(NS,"linearGradient"); grad.setAttribute("id",gradId); grad.setAttribute("x1","0"); grad.setAttribute("y1","0"); grad.setAttribute("x2","0"); grad.setAttribute("y2","1");
  const stop1=document.createElementNS(NS,"stop"); stop1.setAttribute("offset","0%"); stop1.setAttribute("stop-color","rgba(0,0,0,0.02)");
  const stop2=document.createElementNS(NS,"stop"); stop2.setAttribute("offset","100%"); stop2.setAttribute("stop-color","rgba(0,0,0,0.06)");
  grad.appendChild(stop1); grad.appendChild(stop2); defs.appendChild(grad); svg.appendChild(defs);
  const bg=document.createElementNS(NS,"rect"); bg.setAttribute("x",0); bg.setAttribute("y",0); bg.setAttribute("width",600); bg.setAttribute("height",420); bg.setAttribute("fill","url(#"+gradId+")"); svg.appendChild(bg);

  const grid=document.createElementNS(NS,"g"); grid.setAttribute("stroke","rgba(120,140,140,.15)"); grid.setAttribute("stroke-width","1");
  for(let x=0;x<=600;x+=20){const ln=document.createElementNS(NS,"line"); ln.setAttribute("x1",x); ln.setAttribute("y1",0); ln.setAttribute("x2",x); ln.setAttribute("y2",420); grid.appendChild(ln)}
  for(let y=0;y<=420;y+=20){const ln=document.createElementNS(NS,"line"); ln.setAttribute("x1",0); ln.setAttribute("y1",y); ln.setAttribute("x2",600); ln.setAttribute("y2",y); grid.appendChild(ln)}
  svg.appendChild(grid);

  const baseColors=["#ececec","#efefef","#f4f4f4","#f0f0f0","#ededed"];
  const blocks=document.createElementNS(NS,"g"); svg.appendChild(blocks);
  for(let i=0;i<10;i++){ const w=50+Math.floor(rnd()*150), h=28+Math.floor(rnd()*130);
    const x=Math.floor(rnd()*(600-w)), y=Math.floor(rnd()*(420-h));
    const r=document.createElementNS(NS,"rect"); r.setAttribute("x",x); r.setAttribute("y",y); r.setAttribute("width",w); r.setAttribute("height",h);
    r.setAttribute("fill",pick(baseColors)); r.setAttribute("stroke","#d7d7d7"); r.setAttribute("stroke-width","1.2"); r.setAttribute("rx","4"); blocks.appendChild(r);
  }
  const panels=document.createElementNS(NS,"g"); svg.appendChild(panels);
  for(let i=0;i<28;i++){ const w=12+Math.floor(rnd()*34), h=10+Math.floor(rnd()*28);
    const x=Math.floor(rnd()*(600-w)), y=Math.floor(rnd()*(420-h));
    const r=document.createElementNS(NS,"rect"); r.setAttribute("x",x); r.setAttribute("y",y); r.setAttribute("width",w); r.setAttribute("height",h);
    r.setAttribute("fill","#ffffff"); r.setAttribute("stroke","#cfcfcf"); r.setAttribute("stroke-width","1"); r.setAttribute("rx","2"); panels.appendChild(r);
  }
  const accents=document.createElementNS(NS,"g"); svg.appendChild(accents);
  for(let i=0;i<7;i++){ const x1=Math.floor(rnd()*600), y1=Math.floor(rnd()*420);
    const x2=x1+(-70+Math.floor(rnd()*140)), y2=y1+(-70+Math.floor(rnd()*140));
    const ln=document.createElementNS(NS,"line"); ln.setAttribute("x1",x1); ln.setAttribute("y1",y1); ln.setAttribute("x2",x2); ln.setAttribute("y2",y2);
    ln.setAttribute("stroke","#cbdede"); ln.setAttribute("stroke-width",4); ln.setAttribute("stroke-linecap","round"); accents.appendChild(ln);
  }

  // Apply mods subtly (no teal). These mimic native elements.
  mods.forEach(m=>{
    if(m.type==="dot"){ // add a "window" panel
      const r=document.createElementNS(NS,"rect"); r.setAttribute("x",m.x-(m.r||10)); r.setAttribute("y",m.y-(m.r||10));
      const size=(m.r||10)*2; r.setAttribute("width",size); r.setAttribute("height",size*0.8);
      r.setAttribute("fill","#ffffff"); r.setAttribute("stroke","#cfcfcf"); r.setAttribute("stroke-width","1"); r.setAttribute("rx","2"); svg.appendChild(r);
    } else if(m.type==="bar"){ // add a long panel
      const r=document.createElementNS(NS,"rect"); r.setAttribute("x", m.x-(m.w/2)); r.setAttribute("y", m.y-(m.h/2)); r.setAttribute("width", m.w); r.setAttribute("height", m.h);
      r.setAttribute("fill","#ffffff"); r.setAttribute("stroke","#cfcfcf"); r.setAttribute("stroke-width","1"); r.setAttribute("rx","2"); svg.appendChild(r);
    } else if(m.type==="beam"){ // subtle accent beam
      const ln=document.createElementNS(NS,"line"); ln.setAttribute("x1",m.x1); ln.setAttribute("y1",m.y1); ln.setAttribute("x2",m.x2); ln.setAttribute("y2",m.y2);
      ln.setAttribute("stroke","#cbdede"); ln.setAttribute("stroke-width", m.w || 4); ln.setAttribute("stroke-linecap","round"); svg.appendChild(ln);
    }
  });
}

/* ====== Diffs & Modes ====== */
function generateDiffs(seed, count, scale=1){
  let s=seed; function rnd(){ s=(s*9301+49297)%233280; return s/233280; }
  const diffs=[];
  for(let i=0;i<count;i++){
    const t=rnd();
    if(t<0.33) diffs.push({type:"dot",x:30+rnd()*540,y:30+rnd()*360,r:8+Math.floor(8*scale),hitR:12+Math.floor(8*scale)});
    else if(t<0.66) diffs.push({type:"bar",x:40+rnd()*520,y:40+rnd()*340,w:36+Math.floor(64*scale),h:10+Math.floor(12*scale),hitR:12+Math.floor(6*scale)});
    else {const x1=40+rnd()*520,y1=40+rnd()*340,x2=x1+(-50+rnd()*100),y2=y1+(-50*rnd()*2+50); diffs.push({type:"beam",x1,y1,x2,y2,w:5+Math.floor(6*scale),hitR:11+Math.floor(5*scale)})}
  }
  return diffs;
}

const classicLevels = Array.from({length:8},(_,i)=>({seed:100+i*173,diffs:generateDiffs(500+i*79,5+(i%2),1-(i>3?0.2:0))}));

let mode="classic"; // classic | endless | daily
let levelIndex=0, diffs=[], found=0, solvedSet=new Set();
let timer=0, timerId=null, freezeLeft=0, penalty=2, score=0;
const best=load("dq_best_v31",{}); const achievements=load("dq_ach_v31",{daily:false,fast:false,share:false,purchased:false});
const PAY_URL = "https://your-checkout-or-link.com"; // <- replace with your real checkout link
const PRO_KEY = "DESIGN-VIP"; // redeem code

function setHUD(){
  $("#modeBadge").textContent=mode==="classic"?"Classic":(mode==="endless"?"Endless":"Daily");
  $("#levelPill").textContent=mode==="classic"?`Level: ${levelIndex+1}/${classicLevels.length}`:`Level: ${levelIndex+1}`;
  $("#foundPill").textContent=`Found: ${found} / ${diffs.length}`;
  $("#diffCountBadge").textContent=`${diffs.length} differences`; $("#penaltyBadge").textContent=`+${penalty}s misclick`;
  $("#timerPill").textContent=`Time: ${fmt(Math.floor(timer/60))}:${fmt(timer%60)}`;
  $("#scorePill").textContent=`Score: ${score}`;
  const key=`${mode}-${levelIndex}`; const b=best[key]; $("#bestPill").textContent=b?`Best: ${fmt(Math.floor(b/60))}:${fmt(b%60)}`:"Best: ‚Äî";
  const achTxt=Object.keys(achievements).filter(k=>achievements[k]).length?`üèÖ ${Object.keys(achievements).filter(k=>achievements[k]).length} Achievements`:"No Achievements Yet";
  $("#achBadge").textContent=achTxt;
}

function startTimer(){ if(timerId) clearInterval(timerId); timer=0; timerId=setInterval(()=>{ if(freezeLeft>0){freezeLeft--; return;} timer++; setHUD(); },1000) }
function stopTimer(){ clearInterval(timerId); timerId=null }

function adaptiveFactor(){
  const key=`${mode}-${levelIndex}`; const b=best[key];
  if(!b) return {extra:0, shrink:0};
  if(b<=30) return {extra:1, shrink:0.1};
  if(b<=50) return {extra:0, shrink:0.05};
  return {extra:0, shrink:0};
}
function dailySeed(){ const d=new Date(); achievements.daily=true; store("dq_ach_v31",achievements); return d.getUTCFullYear()*10000+(d.getUTCMonth()+1)*100+d.getUTCDate(); }

function buildLevel(){
  solvedSet=new Set(); found=0;
  const seedBase = (mode==="daily") ? dailySeed() : 900 + levelIndex*97 + (mode==="endless"?Math.floor(Math.random()*1000):0);
  const adapt = adaptiveFactor();
  const diffCount = (mode==="classic"? classicLevels[levelIndex].diffs.length : 5 + Math.floor(levelIndex/3) + adapt.extra);
  const scale = Math.max(0.55, 1 - levelIndex*0.03 - adapt.shrink);
  const seed = (mode==="classic"? classicLevels[levelIndex].seed : seedBase);
  diffs = (mode==="classic"? classicLevels[levelIndex].diffs : generateDiffs(seedBase, diffCount, scale));

  drawScene($("#svgLeft"), seed, []);
  drawScene($("#svgRight"), seed, diffs); // same scene but with subtle mods blended in
  renderHotspots();
  startTimer(); setHUD(); $("#statusLine").textContent="Find all differences. Found spots pulse then vanish.";
  maybePaywall();
}
function nextLevel(){ levelIndex = (mode==="classic")? (levelIndex+1)%classicLevels.length : levelIndex+1; buildLevel(); }

function renderHotspots(){
  const svg=$("#svgRight"); Array.from(svg.querySelectorAll(".hot")).forEach(n=>n.remove());
  diffs.forEach((d,i)=>{
    const g=document.createElementNS("http://www.w3.org/2000/svg","g"); g.classList.add("hot"); g.style.cursor="pointer";
    let hit,cx,cy,hitR=d.hitR||12;
    if(d.type==="dot"){ hit=document.createElementNS("http://www.w3.org/2000/svg","circle"); hit.setAttribute("cx",d.x); hit.setAttribute("cy",d.y); hit.setAttribute("r",hitR); cx=d.x; cy=d.y; }
    else if(d.type==="bar"){ hit=document.createElementNS("http://www.w3.org/2000/svg","rect"); hit.setAttribute("x",d.x-(d.w/2+8)); hit.setAttribute("y",d.y-(d.h/2+8)); hit.setAttribute("width",d.w+16); hit.setAttribute("height",d.h+16); hit.setAttribute("rx",6); cx=d.x; cy=d.y; }
    else { const mx=(d.x1+d.x2)/2,my=(d.y1+d.y2)/2; hit=document.createElementNS("http://www.w3.org/2000/svg","circle"); hit.setAttribute("cx",mx); hit.setAttribute("cy",my); hit.setAttribute("r",hitR); cx=mx; cy=my; }
    hit.setAttribute("fill","rgba(0,0,0,0)"); hit.setAttribute("stroke","rgba(0,0,0,0)"); g.appendChild(hit);

    // transient pulse marker
    const marker=document.createElementNS("http://www.w3.org/2000/svg","circle");
    marker.setAttribute("cx",cx); marker.setAttribute("cy",cy); marker.setAttribute("r",18);
    marker.setAttribute("fill","rgba(21,179,109,.22)"); marker.setAttribute("stroke","#15b36d"); marker.setAttribute("stroke-width","2");
    marker.style.opacity=0; g.appendChild(marker);

    g.addEventListener("click", e=>{
      if(solvedSet.has(i)) return;
      solvedSet.add(i); found++; score += 100;
      marker.style.transition="opacity .12s ease, transform .2s ease"; marker.style.opacity=1; marker.style.transform="scale(1.06)";
      setTimeout(()=>{ marker.style.opacity=0; }, 280); // fade away fast
      sfx("ok"); toast("Correct!");
      $("#statusLine").innerHTML=`‚úÖ Found ${found}/${diffs.length}`;
      setHUD();
      if(found===diffs.length){
        stopTimer(); confetti(150); sfx("win");
        score += Math.max(0, 300 - timer*2);
        const key=`${mode}-${levelIndex}`; if(!best[key] || timer<best[key]) best[key]=timer; store("dq_best_v31",best);
        if(timer<=30) achievements.fast=true; store("dq_ach_v31",achievements);
        $("#statusLine").innerHTML=`üéâ Level complete in <strong>${fmt(Math.floor(timer/60))}:${fmt(timer%60)}</strong>. Score +${Math.max(0, 300 - timer*2)}. Next level ‚Üí`;
        setHUD();
      }
    });

    svg.appendChild(g);
  });

  // Misclick penalty
  svg.addEventListener("click", e=>{
    if(!e.target.closest(".hot")){
      timer += 2; score -= 20; setHUD();
      $("#panel").classList.remove("shake"); void $("#panel").offsetWidth; $("#panel").classList.add("shake");
      sfx("miss"); toast(`Miss! +2s`);
    }
  });
}

/* ====== Viral Hooks: Challenge Links ====== */
function shareChallenge(){
  const seed = 100000 + Math.floor(Math.random()*900000);
  const url = new URL(location.href.split('#')[0]);
  url.searchParams.set("mode","challenge");
  url.searchParams.set("seed", String(seed));
  navigator.clipboard.writeText(url.toString())
    .then(()=> toast("Challenge link copied!"))
    .catch(()=> alert(url.toString()));
  achievements.share = true; store("dq_ach_v31",achievements);
}
function parseChallenge(){
  const p = new URLSearchParams(location.search);
  if(p.get("mode")==="challenge"){
    mode="endless"; levelIndex=0;
    const s = Number(p.get("seed")||"0");
    if(s>0){ buildChallengeFromSeed(s); return true; }
  }
  return false;
}
function buildChallengeFromSeed(seed){
  solvedSet=new Set(); found=0;
  diffs = generateDiffs(seed, 7, 1);
  drawScene($("#svgLeft"), seed, []);
  drawScene($("#svgRight"), seed, diffs);
  renderHotspots(); startTimer(); setHUD();
  $("#statusLine").textContent="Community Challenge ‚Äî same seed for everyone. Share your time!";
}

/* ====== Paywall & Monetization ====== */
function maybePaywall(){
  const pro = load("dq_pro", false);
  if(pro) return;
  const shareCount = load("dq_shares", 0);
  // Trigger paywall if endless past level 10 or classic loops
  if( (mode==="endless" && levelIndex>=10) || (mode==="classic" && levelIndex>7) ){
    $("#paywall").style.display="flex";
  }
}
$("#buyBtn").addEventListener("click", ()=>{ window.open(PAY_URL, "_blank"); });
$("#shareBtn").addEventListener("click", ()=>{
  const u = location.href.split('#')[0];
  navigator.clipboard.writeText(u).then(()=>{ toast("Link copied ‚Äî share with friends!"); });
  const c = load("dq_shares",0)+1; store("dq_shares",c);
  if(c>=3){ store("dq_pro",true); $("#paywall").style.display="none"; toast("Pro unlocked by sharing!"); }
});
$("#redeemBtn").addEventListener("click", ()=>{
  const v = $("#redeemCode").value.trim().toUpperCase();
  if(v===PRO_KEY){ store("dq_pro",true); $("#paywall").style.display="none"; toast("Pro unlocked ‚Äî enjoy!"); }
  else{ toast("Invalid code"); }
});

/* ====== Controls ====== */
$("#startBtn").addEventListener("click", ()=>{ if(!parseChallenge()) buildLevel(); });
$("#nextBtn").addEventListener("click", ()=>{ levelIndex = (mode==="classic")? (levelIndex+1)%classicLevels.length : levelIndex+1; buildLevel(); });
$("#endlessBtn").addEventListener("click", ()=>{ mode = (mode==="endless"? "classic" : "endless"); levelIndex=0; buildLevel(); });
$("#dailyBtn").addEventListener("click", ()=>{ mode="daily"; levelIndex=0; buildLevel(); });
$("#freezeBtn").addEventListener("click", ()=>{ freezeLeft = Math.max(freezeLeft, 5); toast("Timer frozen for 5s"); });
$("#zoomBtn").addEventListener("click", ()=> startZoom(4000));
$("#shareChallengeBtn").addEventListener("click", shareChallenge);
$("#themeBtn").addEventListener("click", ()=>{ const night=document.body.getAttribute("data-theme")==="night"; document.body.setAttribute("data-theme", night? "" : "night"); buildLevel(); });
$("#muteBtn").addEventListener("click", ()=>{ muted=!muted; $("#muteBtn").textContent = muted? "üîá Sound Off":"üîä Sound On"; if(ac.state==="suspended") ac.resume(); });

// init
if(!parseChallenge()) buildLevel();
</script>
</body>
</html>
