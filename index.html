<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Design Quest ‚Äì Spot & Win (v3.3 Pro + Funny + Realistic)</title>
<style>
  :root{
    --bg:#f6f3ee; --ink:#171717; --muted:#7d8a8a; --accent:#00a3a3; --card:#ffffff;
    --ok:#19b36f; --err:#d13f3f; --shadow:0 12px 36px rgba(0,0,0,.10); --radius:18px;
  }
  [data-theme="night"]{ --bg:#0d1115; --ink:#e9f3f3; --muted:#9ab0b0; --accent:#23d2d2; --card:#11171b; --shadow:0 16px 40px rgba(0,0,0,.45) }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font-family: Inter, ui-sans-serif, system-ui; color:var(--ink); background:var(--bg); overflow-x:hidden }
  .skyline{ position:fixed; inset:0; z-index:-2; background:
      linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,0) 40%) no-repeat,
      radial-gradient(1000px 600px at 80% -10%, rgba(0,163,163,.10), transparent 70%) no-repeat,
      linear-gradient(180deg, #dfeff0, #f6f3ee 60%) }
  .city{ position:fixed; bottom:0; left:-10vw; width:130vw; height:20vh; z-index:-1;
    background:
      repeating-linear-gradient(90deg, #b7c4c7 0 120px, transparent 120px 160px) bottom / 100% 50% no-repeat,
      repeating-linear-gradient(90deg, #a5b3b6 0 90px, transparent 90px 130px) bottom / 100% 85% no-repeat;
    opacity:.25; filter:blur(1px); transform:translateY(0);
    animation: drift 22s linear infinite alternate;
  }
  @keyframes drift{ to{ transform:translateY(6px) translateX(-2vw) } }
  .sun{ position:fixed; top:-100px; left:-100px; width:220px; height:220px; border-radius:50%; background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,215,120,.55), rgba(255,200,80,.15) 60%, transparent 70%); filter:blur(2px); animation: sunmove 40s linear infinite }
  [data-theme="night"] .sun{ display:none }
  @keyframes sunmove{ 0%{ transform:translate(0,0) } 50%{ transform:translate(calc(100vw - 200px), 30vh) } 100%{ transform:translate(0,0) } }
  .grain{ pointer-events:none; position:fixed; inset:0; z-index:0; opacity:.08; mix-blend-mode:multiply; background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="220" height="220"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>'); background-size:220px 220px }
  .container{max-width:1240px;margin:34px auto 56px;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center;font-weight:900}
  .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 6px rgba(0,163,163,.13)}
  .hud{display:flex;gap:10px;flex-wrap:wrap}
  .pill{background:#eaf7f7;border:1px solid rgba(0,163,163,.28);color:#0b4c4c;padding:8px 12px;border-radius:999px;font-weight:800;font-size:13px}
  [data-theme="night"] .pill{background:#122024;color:#9adfdf;border-color:#1c3e3e}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden; position:relative; z-index:1 }
  .hero{padding:26px 24px;border-bottom:1px solid #e6ecec;display:flex;gap:16px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  [data-theme="night"] .hero{border-color:#233239}
  .title{font-size:26px;margin:0 0 6px 0}
  .subtitle{margin:0;color:var(--muted)}
  button,.btn{appearance:none;border:none;background:var(--accent);color:white;padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:800;transition:transform .05s ease, opacity .2s ease;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  button:active{transform:translateY(1px)}
  .btn-secondary{background:#e9f7f7;color:#0c5555}
  .btn-ghost{background:transparent;color:var(--accent);border:1px solid rgba(0,163,163,.35)}
  .btn-warning{background:#ffe7b3;color:#6a5207}
  .stage{position:relative;min-height:580px;display:flex;align-items:stretch;justify-content:stretch;padding:18px}
  .panel{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:10px;flex:1;min-height:540px}
  .boards{display:grid;grid-template-columns:1fr 1fr;gap:12px;flex:1}
  .board{background:linear-gradient(180deg,#fafafa,#f2f2f2);border-radius:12px;position:relative;overflow:hidden;border:1px solid #ececec}
  [data-theme="night"] .board{background:linear-gradient(180deg,#101418,#0c1013);border-color:#1a2328}
  svg{width:100%;height:100%}
  .divider{height:1px;background:#eee;margin:8px 0}
  [data-theme="night"] .divider{background:#26343a}
  .status{display:flex;align-items:center;gap:8px;min-height:24px}
  .shake{animation:shake .25s ease}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}
  .toast{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(10px);transition:all .25s ease;z-index:9999;font-weight:800}
  .toast.show{opacity:1;transform:translateY(0)}
  .npc{font-size:12px;color:var(--muted);padding:0 24px 12px}
  /* Modal paywall */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:99999}
  .modal .box{background:var(--card);padding:20px;border-radius:16px;box-shadow:var(--shadow);max-width:560px;width:92%}
  .modal h2{margin:0 0 6px 0}
  .modal p{margin:6px 0;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  input[type="text"]{padding:10px 12px;border-radius:10px;border:1px solid #d8eaea;outline:none;background:#fff;min-width:180px}
</style>
</head>
<body>
<div class="skyline"></div>
<div class="city"></div>
<div class="sun"></div>
<div class="grain"></div>

<!-- Paywall Modal -->
<div class="modal" id="paywall">
  <div class="box">
    <h2>Unlock <span style="color:var(--accent)">Pro Levels</span></h2>
    <p>You're on fire! Get endless levels, daily challenges, and pro power‚Äëups without limits.</p>
    <ul style="margin:6px 0 0 18px;color:var(--muted)">
      <li>Unlimited Endless mode</li>
      <li>Daily global challenge</li>
      <li>Freeze & Zoom power‚Äëups x10</li>
      <li>Exclusive ‚ÄúArchitect Story‚Äù episodes</li>
    </ul>
    <div class="row">
      <button id="buyBtn">üöÄ Continue ‚Äì Pro Pass</button>
      <button class="btn btn-secondary" id="shareBtn">üîó Share to unlock</button>
    </div>
    <div class="row">
      <input id="redeemCode" type="text" placeholder="Have a code? (e.g., DESIGN‚ÄëVIP)">
      <button class="btn btn-ghost" id="redeemBtn">Redeem</button>
    </div>
    <p style="font-size:12px">Tip: Sharing this game with 3 friends unlocks Pro for free on this device.</p>
  </div>
</div>

<div class="container">
  <header>
    <div class="brand"><span class="dot"></span>Design Quest ‚Äì Spot & Win <span class="pill" id="modeBadge">Endless</span></div>
    <div class="hud">
      <div class="pill" id="levelPill">Level: 1</div>
      <div class="pill" id="foundPill">Found: 0 / 5</div>
      <div class="pill" id="timerPill">Time: 00:00</div>
      <div class="pill" id="scorePill">Score: 0</div>
      <div class="pill" id="bestPill">Best: ‚Äî</div>
    </div>
  </header>

  <div class="card">
    <div class="hero">
      <div>
        <h1 class="title">v3.3 ‚Äî Funny + Realistic + Pro monetization + Challenge mode.</h1>
        <p class="subtitle">Realistic architecture, jokes, viral challenge links, soft paywall, and optional global leaderboard.</p>
      </div>
      <div class="toolbar">
        <button id="startBtn">Start / Restart</button>
        <button class="btn btn-secondary" id="nextBtn">Next Level</button>
        <button class="btn btn-ghost" id="challengeBtn">üèÜ Share challenge</button>
        <button class="btn btn-ghost" id="dailyBtn">üìÖ Daily</button>
        <button class="btn btn-ghost" id="themeBtn">üåô Night</button>
        <button class="btn btn-ghost" id="muteBtn">üîä Sound On</button>
      </div>
    </div>

    <div class="npc" id="npc">üë∑‚Äç‚ôÇÔ∏è <em>Architect NPC:</em> ‚ÄúCoffee ready? Your eyes will do cardio today.‚Äù</div>

    <div class="stage">
      <div class="panel" id="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;color:var(--muted)">Game Boards</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="pill" id="diffCountBadge">5 differences</span>
            <span class="pill" id="penaltyBadge">+2s misclick</span>
          </div>
        </div>
        <div class="boards">
          <div class="board"><svg id="svgLeft" viewBox="0 0 600 420" preserveAspectRatio="xMidYMid slice"></svg></div>
          <div class="board"><svg id="svgRight" viewBox="0 0 600 420" preserveAspectRatio="xMidYMid slice"></svg></div>
        </div>
        <div class="divider"></div>
        <div class="status" id="statusLine">Click the differences on the right board. No spoilers. üòè</div>
        <div class="divider"></div>
        <!-- Leaderboard (local or Firebase) -->
        <div id="leaderboard" style="display:none">
          <h4 style="margin:6px 0">Leaderboard (fastest times)</h4>
          <div id="scores" style="font-size:13px;color:var(--muted)">Loading‚Ä¶</div>
        </div>
      </div>
    </div>
    <footer style="padding:14px 18px;color:var(--muted);font-size:12px">Host as <strong>index.html</strong> on GitHub Pages. Embed URL in Canva via <strong>Apps ‚Üí Embed</strong>.</footer>
  </div>
</div>

<div class="toast" id="toast">Correct!</div>

<script>
/* ====== Config (edit these) ====== */
const PAY_URL = "https://your-checkout-or-link.com";       // <-- replace with Stripe/PayPal link
const PRO_KEY = "DESIGN-VIP";                               // <-- change redeem code
const USE_FIREBASE = false;                                  // set true and paste config below to enable global leaderboard
const FIREBASE_CONFIG = {
  // paste your Firebase web config here when ready
};
/* ====== Firebase scaffold (optional) ====== */
let fb = null;
async function initFirebase(){
  if(!USE_FIREBASE) return;
  const app = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js');
  const dbm = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
  const appInst = app.initializeApp(FIREBASE_CONFIG);
  const db = dbm.getFirestore(appInst);
  fb = { db, ...dbm };
  $("#leaderboard").style.display = "block";
}
async function pushScore(name, ms){
  if(!fb) return;
  const col = fb.collection(fb.db, "dq_scores");
  await fb.addDoc(col, { name, ms, ts: Date.now() });
}
async function fetchScores(){
  if(!fb) return;
  const q = fb.query(fb.collection(fb.db,"dq_scores"), fb.orderBy("ms","asc"), fb.limit(10));
  const snap = await fb.getDocs(q);
  const list = []; snap.forEach(d=> list.push(d.data()));
  $("#scores").innerHTML = list.map((s,i)=> `${i+1}. ${s.name} ‚Äî ${fmt(Math.floor(s.ms/60))}:${fmt(Math.floor(s.ms%60))}`).join("<br>") || "No scores yet.";
}

/* ====== Utilities & Audio ====== */
const $ = sel => document.querySelector(sel);
const fmt = s => String(s).padStart(2,'0');
const store=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch(e){return d}};
let muted=false; const ac=new (window.AudioContext||window.webkitAudioContext)();
function sfx(type="ok"){ if(muted) return; const o=ac.createOscillator(), g=ac.createGain(); o.connect(g); g.connect(ac.destination); const t=ac.currentTime;
  if(type==="ok"){o.type="sine";o.frequency.setValueAtTime(930,t);g.gain.setValueAtTime(.0001,t);g.gain.exponentialRampToValueAtTime(.22,t+.01);g.gain.exponentialRampToValueAtTime(.0001,t+.25)}
  if(type==="win"){o.type="triangle";o.frequency.setValueAtTime(420,t);o.frequency.linearRampToValueAtTime(760,t+.25);o.frequency.linearRampToValueAtTime(1110,t+.55);g.gain.setValueAtTime(.0001,t);g.gain.exponentialRampToValueAtTime(.28,t+.01);g.gain.exponentialRampToValueAtTime(.0001,t+.6)}
  if(type==="miss"){o.type="sawtooth";o.frequency.setValueAtTime(160,t);g.gain.setValueAtTime(.0001,t);g.gain.exponentialRampToValueAtTime(.18,t+.01);g.gain.exponentialRampToValueAtTime(.0001,t+.18)}
  o.start(); o.stop(t+.7);
}
function toast(text){const el=$("#toast"); el.textContent=text; el.classList.add("show"); clearTimeout(toast._t); toast._t=setTimeout(()=>el.classList.remove("show"), 950);}
function say(line){ $("#npc").innerHTML = "üë∑‚Äç‚ôÇÔ∏è <em>Architect NPC:</em> ‚Äú"+line+"‚Äù"; }

/* ====== Jokes / NPC lines ====== */
const LINES = {
  start: ["Coffee ready? Your eyes will do cardio today.","If you blink, the building permits expire.","Find 5 differences or the client will add 50 more."],
  miss: ["Nope. That was a pigeon.","If that was a wall, it moved out.","Close! But the building code said ‚Äònah‚Äô. "],
  hit: ["Spotted! Your eyes pay rent.","Boom. Permit approved.","That window confessed. Nice."],
  win: ["Level cleared! The city applauds (quietly).","You‚Äôre built different. Literally.","Plot twist: the last difference was your patience."]
};

/* ====== Confetti ====== */
const fxCanvas = document.createElement('canvas'); fxCanvas.id="fx"; document.body.appendChild(fxCanvas);
const fx = fxCanvas.getContext("2d"); function fxResize(){fxCanvas.width=innerWidth; fxCanvas.height=innerHeight} window.addEventListener('resize',fxResize); fxResize();
const parts=[]; function confetti(n=120){ for(let i=0;i<n;i++){ parts.push({x:Math.random()*fxCanvas.width,y:-10,vx:-2+Math.random()*4,vy:2+Math.random()*3,rot:Math.random()*6,vr:-.1+.2*Math.random(),s:4+Math.random()*6,life:120+Math.random()*60}) } }
;(function loop(){ fx.clearRect(0,0,fxCanvas.width,fxCanvas.height); parts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.rot+=p.vr;p.life--; fx.save(); fx.translate(p.x,p.y); fx.rotate(p.rot); fx.fillStyle=`hsl(${(p.x+p.y)%360},70%,${50+(p.vr*50)}%)`; fx.fillRect(-p.s/2,-p.s/2,p.s,p.s); fx.restore();}); for(let i=parts.length-1;i>=0;i--) if(parts[i].life<=0||parts[i].y>fxCanvas.height+20) parts.splice(i,1); requestAnimationFrame(loop) })();

/* ====== Scene Generator (realistic) ====== */
function drawScene(svg, seed, mods=[]){
  svg.innerHTML="";
  const NS="http://www.w3.org/2000/svg";
  let s=seed; function rnd(){ s=(s*9301+49297)%233280; return s/233280; } function pick(a){return a[Math.floor(rnd()*a.length)]}
  const defs=document.createElementNS(NS,"defs");
  const sh=document.createElementNS(NS,"filter"); sh.setAttribute("id","drop"); sh.innerHTML='<feDropShadow dx="0.6" dy="1.2" stdDeviation="1.2" flood-color="rgba(0,0,0,.3)"/>'; defs.appendChild(sh);
  const glass=document.createElementNS(NS,"linearGradient"); glass.setAttribute("id","glass"); glass.setAttribute("x1","0"); glass.setAttribute("y1","0"); glass.setAttribute("x2","0"); glass.setAttribute("y2","1");
  const gs1=document.createElementNS(NS,"stop"); gs1.setAttribute("offset","0%"); gs1.setAttribute("stop-color","#eaf7fa"); glass.appendChild(gs1);
  const gs2=document.createElementNS(NS,"stop"); gs2.setAttribute("offset","100%"); gs2.setAttribute("stop-color","#cfe5ea"); glass.appendChild(gs2);
  defs.appendChild(glass); svg.appendChild(defs);

  const grid=document.createElementNS(NS,"g"); grid.setAttribute("stroke","rgba(120,140,140,.18)"); grid.setAttribute("stroke-width","1");
  for(let x=0;x<=600;x+=20){const ln=document.createElementNS(NS,"line"); ln.setAttribute("x1",x); ln.setAttribute("y1",0); ln.setAttribute("x2",x); ln.setAttribute("y2",420); grid.appendChild(ln)}
  for(let y=0;y<=420;y+=20){const ln=document.createElementNS(NS,"line"); ln.setAttribute("x1",0); ln.setAttribute("y1",y); ln.setAttribute("x2",600); ln.setAttribute("y2",y); grid.appendChild(ln)}
  svg.appendChild(grid);

  const concretes = ["#e7e5e1","#eae8e4","#ddd9d3","#e2dfda"];
  for(let i=0;i<8;i++){
    const w=60+Math.floor(rnd()*140), h=34+Math.floor(rnd()*120);
    const x=Math.floor(rnd()*(600-w)), y=Math.floor(rnd()*(420-h));
    const r=document.createElementNS(NS,"rect");
    r.setAttribute("x",x); r.setAttribute("y",y); r.setAttribute("width",w); r.setAttribute("height",h);
    r.setAttribute("fill", pick(concretes)); r.setAttribute("stroke","#cfcac2"); r.setAttribute("stroke-width","1.2"); r.setAttribute("rx","4"); r.setAttribute("filter","url(#drop)");
    svg.appendChild(r);
  }
  for(let i=0;i<26;i++){
    const w=12+Math.floor(rnd()*30), h=10+Math.floor(rnd()*26);
    const x=Math.floor(rnd()*(600-w)), y=Math.floor(rnd()*(420-h));
    const r=document.createElementNS(NS,"rect"); r.setAttribute("x",x); r.setAttribute("y",y); r.setAttribute("width",w); r.setAttribute("height",h);
    r.setAttribute("fill","url(#glass)"); r.setAttribute("stroke","#b9cbd0"); r.setAttribute("stroke-width","1"); r.setAttribute("rx","2");
    svg.appendChild(r);
  }
  for(let i=0;i<7;i++){
    const x1=Math.floor(rnd()*600), y1=Math.floor(rnd()*420);
    const x2=x1+(-70+Math.floor(rnd()*140)), y2=y1+(-70+Math.floor(rnd()*140));
    const ln=document.createElementNS(NS,"line"); ln.setAttribute("x1",x1); ln.setAttribute("y1",y1); ln.setAttribute("x2",x2); ln.setAttribute("y2",y2);
    ln.setAttribute("stroke","#bcd5d8"); ln.setAttribute("stroke-width",4); ln.setAttribute("stroke-linecap","round");
    svg.appendChild(ln);
  }

  mods.forEach(m=>{
    if(m.kind==="light"){
      const r=document.createElementNS(NS,"rect"); r.setAttribute("x",m.x); r.setAttribute("y",m.y); r.setAttribute("width",m.w); r.setAttribute("height",m.h);
      r.setAttribute("fill","#ffe89a"); r.setAttribute("stroke","#d4c27a"); r.setAttribute("rx","2"); svg.appendChild(r);
    } else if(m.kind==="rail"){
      const ln=document.createElementNS(NS,"line"); ln.setAttribute("x1",m.x1); ln.setAttribute("y1",m.y1); ln.setAttribute("x2",m.x2); ln.setAttribute("y2",m.y2);
      ln.setAttribute("stroke","#bfc8ca"); ln.setAttribute("stroke-width","3"); ln.setAttribute("stroke-linecap","round"); svg.appendChild(ln);
    } else if(m.kind==="vent"){
      const r=document.createElementNS(NS,"rect"); r.setAttribute("x",m.x); r.setAttribute("y",m.y); r.setAttribute("width",m.w); r.setAttribute("height",m.h);
      r.setAttribute("fill","#d6dadb"); r.setAttribute("stroke","#aeb6b8"); r.setAttribute("rx","2"); svg.appendChild(r);
      for(let k=0;k<4;k++){ const slit=document.createElementNS(NS,"line"); slit.setAttribute("x1",m.x+4); slit.setAttribute("y1",m.y+4+k*4); slit.setAttribute("x2",m.x+m.w-4); slit.setAttribute("y2",m.y+4+k*4); slit.setAttribute("stroke","#aab2b4"); slit.setAttribute("stroke-width","1"); svg.appendChild(slit); }
    }
  });
}

/* ====== Diffs ====== */
function generateDiffs(seed, count){
  let s=seed; function rnd(){ s=(s*9301+49297)%233280; return s/233280; }
  const diffs=[];
  for(let i=0;i<count;i++){
    const t=rnd();
    if(t<0.4){ const x=30+rnd()*540, y=30+rnd()*360, w=12+Math.floor(rnd()*30), h=8+Math.floor(rnd()*12); diffs.push({kind:"light", x,y,w,h, hitR:14}); }
    else if(t<0.75){ const x=40+rnd()*520, y=40+rnd()*340, len=40+Math.floor(rnd()*80); diffs.push({kind:"rail", x1:x, y1:y, x2:x+len, y2:y+(Math.random()>.5?0:2), hitR:12}); }
    else { const x=40+rnd()*520, y=40+rnd()*340, w=20+Math.floor(rnd()*30), h=14+Math.floor(rnd()*10); diffs.push({kind:"vent", x,y,w,h, hitR:12}); }
  }
  return diffs;
}

/* ====== Game State ====== */
let mode="endless", levelIndex=0, diffs=[], found=0, solvedSet=new Set();
let timer=0, timerId=null, penalty=2, score=0;
const best=load("dq_best_v33",{});
const proUnlocked = ()=> load("dq_pro", false);

function setHUD(){
  $("#modeBadge").textContent=mode==="endless"?"Endless":(mode==="daily"?"Daily":"Classic");
  $("#levelPill").textContent=`Level: ${levelIndex+1}`;
  $("#foundPill").textContent=`Found: ${found} / ${diffs.length}`;
  $("#diffCountBadge").textContent=`${diffs.length} differences`; $("#penaltyBadge").textContent=`+${penalty}s misclick`;
  $("#timerPill").textContent=`Time: ${fmt(Math.floor(timer/60))}:${fmt(timer%60)}`;
  $("#scorePill").textContent=`Score: ${score}`;
  const b=best[levelIndex]; $("#bestPill").textContent=b?`Best: ${fmt(Math.floor(b/60))}:${fmt(b%60)}`:"Best: ‚Äî";
}
function startTimer(){ if(timerId) clearInterval(timerId); timer=0; timerId=setInterval(()=>{ timer++; setHUD(); },1000) }
function stopTimer(){ clearInterval(timerId); timerId=null }

function buildLevel(seedOverride=null){
  solvedSet=new Set(); found=0;
  const seed = seedOverride ?? (900 + levelIndex*97 + Math.floor(Math.random()*1000));
  const diffCount = 5 + Math.floor(levelIndex/3);
  diffs = generateDiffs(seed, diffCount);
  drawScene($("#svgLeft"), seed, []);
  drawScene($("#svgRight"), seed, diffs);
  renderHotspots(); startTimer(); setHUD();
  say( LINES.start[Math.floor(Math.random()*LINES.start.length)] );
  if(USE_FIREBASE){ $("#leaderboard").style.display = "block"; fetchScores(); }
  maybePaywall();
}
function nextLevel(){ levelIndex += 1; buildLevel(); }

function renderHotspots(){
  const svg=$("#svgRight"); Array.from(svg.querySelectorAll(".hot")).forEach(n=>n.remove());
  diffs.forEach((d,i)=>{
    const g=document.createElementNS("http://www.w3.org/2000/svg","g"); g.classList.add("hot"); g.style.cursor="pointer";
    let hit,cx,cy,hitR=d.hitR||12;
    if(d.kind==="light"){ hit=document.createElementNS("http://www.w3.org/2000/svg","rect"); hit.setAttribute("x",d.x-6); hit.setAttribute("y",d.y-6); hit.setAttribute("width",d.w+12); hit.setAttribute("height",d.h+12); hit.setAttribute("rx",6); cx=d.x+d.w/2; cy=d.y+d.h/2; }
    else if(d.kind==="rail"){ const mx=(d.x1+d.x2)/2,my=(d.y1+d.y2)/2; hit=document.createElementNS("http://www.w3.org/2000/svg","circle"); hit.setAttribute("cx",mx); hit.setAttribute("cy",my); hit.setAttribute("r",hitR); cx=mx; cy=my; }
    else { hit=document.createElementNS("http://www.w3.org/2000/svg","rect"); hit.setAttribute("x",d.x-6); hit.setAttribute("y",d.y-6); hit.setAttribute("width",d.w+12); hit.setAttribute("height",d.h+12); hit.setAttribute("rx",6); cx=d.x+d.w/2; cy=d.y+d.h/2; }
    hit.setAttribute("fill","rgba(0,0,0,0)"); hit.setAttribute("stroke","rgba(0,0,0,0)"); g.appendChild(hit);

    const marker=document.createElementNS("http://www.w3.org/2000/svg","circle");
    marker.setAttribute("cx",cx); marker.setAttribute("cy",cy); marker.setAttribute("r",18);
    marker.setAttribute("fill","rgba(25,179,111,.22)"); marker.setAttribute("stroke","#19b36f"); marker.setAttribute("stroke-width","2");
    marker.style.opacity=0; g.appendChild(marker);

    g.addEventListener("click", e=>{
      if(solvedSet.has(i)) return;
      solvedSet.add(i); found++; score += 100;
      marker.style.transition="opacity .12s ease, transform .2s ease"; marker.style.opacity=1; marker.style.transform="scale(1.06)";
      setTimeout(()=>{ marker.style.opacity=0; }, 260);
      sfx("ok"); toast("Correct!");
      $("#statusLine").innerHTML=`‚úÖ Found ${found}/${diffs.length}`; setHUD();
      if(found===diffs.length){
        stopTimer(); confetti(140); sfx("win");
        score += Math.max(0, 300 - timer*2); if(!best[levelIndex] || timer<best[levelIndex]) best[levelIndex]=timer; store("dq_best_v33",best);
        $("#statusLine").innerHTML=`üéâ Level ${levelIndex+1} done in <strong>${fmt(Math.floor(timer/60))}:${fmt(timer%60)}</strong>. Next level ‚Üí`;
        if(USE_FIREBASE){ const name = prompt("Name for leaderboard? (3‚Äì12 chars)","Player"); if(name){ pushScore(name.slice(0,12), timer); setTimeout(fetchScores, 800); } }
      }
    });

    svg.appendChild(g);
  });

  svg.addEventListener("click", e=>{
    if(!e.target.closest(".hot")){
      timer += penalty; score -= 20; setHUD();
      $("#panel").classList.remove("shake"); void $("#panel").offsetWidth; $("#panel").classList.add("shake");
      sfx("miss"); toast("Miss! +2s");
    }
  });
}

/* ====== Viral Challenge Links ====== */
function shareChallenge(){
  const seed = 100000 + Math.floor(Math.random()*900000);
  const url = new URL(location.href.split('#')[0]);
  url.searchParams.set("mode","challenge");
  url.searchParams.set("seed", String(seed));
  navigator.clipboard.writeText(url.toString())
    .then(()=> toast("Challenge link copied!"))
    .catch(()=> alert(url.toString()));
}
function parseChallenge(){
  const p = new URLSearchParams(location.search);
  if(p.get("mode")==="challenge"){
    const s = Number(p.get("seed")||"0");
    if(s>0){ mode="endless"; levelIndex=0; buildLevel(s); return true; }
  }
  return false;
}

/* ====== Paywall ====== */
function maybePaywall(){
  if(proUnlocked()) return;
  if( (mode==="endless" && levelIndex>=10) ){ $("#paywall").style.display="flex"; }
}
$("#buyBtn").addEventListener("click", ()=>{ window.open(PAY_URL, "_blank"); });
$("#shareBtn").addEventListener("click", ()=>{
  const u = location.href.split('#')[0];
  navigator.clipboard.writeText(u).then(()=>{ toast("Link copied ‚Äî share with friends!"); });
  const c = load("dq_shares",0)+1; store("dq_shares",c);
  if(c>=3){ store("dq_pro",true); $("#paywall").style.display="none"; toast("Pro unlocked by sharing!"); }
});
$("#redeemBtn").addEventListener("click", ()=>{
  const v = $("#redeemCode").value.trim().toUpperCase();
  if(v===PRO_KEY){ store("dq_pro",true); $("#paywall").style.display="none"; toast("Pro unlocked ‚Äî enjoy!"); }
  else{ toast("Invalid code"); }
});

/* ====== Controls ====== */
$("#startBtn").addEventListener("click", ()=>{ if(!parseChallenge()) buildLevel(); });
$("#nextBtn").addEventListener("click", nextLevel);
$("#challengeBtn").addEventListener("click", shareChallenge);
$("#dailyBtn").addEventListener("click", ()=>{ mode="daily"; levelIndex=0; buildLevel(); });
$("#themeBtn").addEventListener("click", ()=>{ const night=document.body.getAttribute("data-theme")==="night"; document.body.setAttribute("data-theme", night? "" : "night"); });
$("#muteBtn").addEventListener("click", ()=>{ muted=!muted; $("#muteBtn").textContent= muted? "üîá Sound Off":"üîä Sound On"; if(ac.state==="suspended") ac.resume(); });

// init
initFirebase().then(()=> { if(!parseChallenge()) buildLevel(); });
</script>
</body>
</html>
